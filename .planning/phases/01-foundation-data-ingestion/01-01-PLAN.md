---
phase: 01-foundation-data-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - databricks.yml
  - app.yaml
  - pyproject.toml
  - job_monitor/__init__.py
  - job_monitor/backend/app.py
  - job_monitor/backend/core.py
  - job_monitor/backend/config.py
  - job_monitor/backend/routers/health.py
  - job_monitor/ui/routes/_sidebar/dashboard.tsx
autonomous: true
requirements:
  - APP-01
  - APP-02

must_haves:
  truths:
    - "APX project structure exists with FastAPI backend and React frontend"
    - "App can be started locally with uvicorn"
    - "User's Databricks identity is extracted from OBO token header"
    - "Dashboard displays current user email"
  artifacts:
    - path: "databricks.yml"
      provides: "Databricks Asset Bundle configuration"
      contains: "resources"
    - path: "app.yaml"
      provides: "Databricks App configuration with OAuth scopes"
      contains: "DATABRICKS_HOST"
    - path: "job_monitor/backend/app.py"
      provides: "FastAPI application entry point"
      contains: "FastAPI"
    - path: "job_monitor/backend/core.py"
      provides: "Dependency injection for workspace clients"
      contains: "get_ws"
    - path: "job_monitor/ui/routes/_sidebar/dashboard.tsx"
      provides: "Dashboard with user identity display"
      contains: "createFileRoute"
  key_links:
    - from: "job_monitor/backend/app.py"
      to: "job_monitor/backend/routers/health.py"
      via: "FastAPI router include"
      pattern: "include_router"
    - from: "job_monitor/backend/core.py"
      to: "WorkspaceClient"
      via: "dependency injection"
      pattern: "X-Forwarded-Access-Token"
---

<objective>
Initialize the APX project scaffold with Databricks App configuration and OAuth authentication.

Purpose: Establish the foundational project structure that all subsequent phases build upon. This includes the FastAPI backend, React frontend, Databricks Asset Bundle configuration, and OAuth authentication with user identity display.

Output: Working APX project that starts locally, configured for Databricks App deployment with OAuth scopes, displaying authenticated user identity.
</objective>

<execution_context>
@/Users/laurent.prat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/laurent.prat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-data-ingestion/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize APX project with Databricks App configuration</name>
  <files>
    databricks.yml
    app.yaml
    pyproject.toml
    job_monitor/__init__.py
    job_monitor/backend/__init__.py
    job_monitor/backend/app.py
    job_monitor/backend/config.py
    job_monitor/backend/routers/__init__.py
    job_monitor/backend/routers/health.py
  </files>
  <action>
Create APX project structure manually (do NOT use `apx init` - we need control over naming):

1. Create `pyproject.toml` with:
   - Project name: `job-monitor`
   - Dependencies: fastapi>=0.100.0, uvicorn>=0.25.0, databricks-sdk>=0.40.0, pydantic>=2.0
   - Dev dependencies: pytest, httpx

2. Create `databricks.yml` (Databricks Asset Bundle config):
   - Bundle name: `job-monitor`
   - Target: dev (default workspace deployment)
   - Resources section for app configuration

3. Create `app.yaml` with:
   - Command: uvicorn job_monitor.backend.app:app --host 0.0.0.0 --port 8000
   - Environment variables:
     - DATABRICKS_HOST: "${DATABRICKS_HOST}" (will be set during deployment)
     - WAREHOUSE_ID: placeholder for SQL warehouse ID
   - OAuth scopes: sql:*, compute.clusters:read (CRITICAL: required for system table access)

4. Create `job_monitor/backend/app.py`:
   - FastAPI app with title "Job Monitor"
   - Lifespan handler that initializes WorkspaceClient in app.state
   - Include health router
   - CORS middleware for local development

5. Create `job_monitor/backend/config.py`:
   - Pydantic Settings class reading from environment
   - DATABRICKS_HOST, WAREHOUSE_ID fields

6. Create `job_monitor/backend/routers/health.py`:
   - GET /api/health endpoint returning {"status": "ok", "version": "0.1.0"}

CRITICAL: Use underscore package name (job_monitor) not hyphen (job-monitor) for Python imports.
  </action>
  <verify>
    Run: `cd /Users/laurent.prat/Documents/lpdev/databricks_job_monitoring && python -c "from job_monitor.backend.app import app; print(app.title)"`
    Expected: "Job Monitor"
  </verify>
  <done>
    - pyproject.toml exists with correct dependencies
    - databricks.yml configured for bundle deployment
    - app.yaml has OAuth scopes and env vars
    - FastAPI app imports successfully
    - Health endpoint defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement OAuth authentication and user identity display</name>
  <files>
    job_monitor/backend/core.py
    job_monitor/backend/routers/auth.py
    job_monitor/backend/models.py
    job_monitor/ui/routes/_sidebar/dashboard.tsx
    job_monitor/ui/lib/api.ts
  </files>
  <action>
1. Create `job_monitor/backend/core.py`:
   - `get_ws(request: Request)` dependency: returns app.state.workspace_client (Service Principal)
   - `get_user_ws(request, token)` dependency: creates WorkspaceClient from X-Forwarded-Access-Token header
   - `get_current_user(request)` dependency: extracts user email from OBO token or returns "anonymous" for local dev

2. Create `job_monitor/backend/models.py`:
   - `UserInfo` model: email (str), display_name (Optional[str])
   - `HealthResponse` model: status (str), version (str), user (Optional[str])

3. Create `job_monitor/backend/routers/auth.py`:
   - GET /api/me endpoint returning current user info
   - Uses get_current_user dependency
   - Returns UserInfo model

4. Update `job_monitor/backend/app.py`:
   - Include auth router
   - Update health endpoint to include user info

5. Create minimal React frontend structure:
   - `job_monitor/ui/routes/_sidebar/dashboard.tsx`: Dashboard page that fetches /api/me and displays user email
   - `job_monitor/ui/lib/api.ts`: Simple fetch wrapper for API calls

Note: For local development without Databricks OAuth, the app should gracefully handle missing token and show "Local Development Mode".

Implementation pattern for token extraction (from research):
```python
from fastapi import Header
from typing import Annotated

def get_current_user(
    token: Annotated[str | None, Header(alias="X-Forwarded-Access-Token")] = None,
) -> str:
    if token:
        # In production, decode JWT to get user email
        # For now, return placeholder until deployed
        return "authenticated-user@databricks.com"
    return "local-dev-user"
```
  </action>
  <verify>
    Run: `cd /Users/laurent.prat/Documents/lpdev/databricks_job_monitoring && python -c "from job_monitor.backend.core import get_current_user; print('core imports ok')"`
    Run: `cd /Users/laurent.prat/Documents/lpdev/databricks_job_monitoring && python -c "from job_monitor.backend.routers.auth import api; print('auth router ok')"`
  </verify>
  <done>
    - core.py has get_ws, get_user_ws, get_current_user dependencies
    - auth.py has /api/me endpoint
    - models.py has UserInfo and HealthResponse
    - Dashboard component exists with user display placeholder
    - App starts without errors: `uvicorn job_monitor.backend.app:app`
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `python -m pytest` passes (if tests exist)
2. `uvicorn job_monitor.backend.app:app --reload` starts without errors
3. `curl http://localhost:8000/api/health` returns {"status": "ok", ...}
4. `curl http://localhost:8000/api/me` returns user info
5. Project structure matches APX conventions
</verification>

<success_criteria>
- FastAPI app starts locally on port 8000
- Health check endpoint returns 200
- User identity endpoint returns user info (local-dev-user for local, real user when deployed)
- databricks.yml and app.yaml ready for `databricks bundle deploy`
- OAuth scopes configured for system table access
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-ingestion/01-01-SUMMARY.md`
</output>
